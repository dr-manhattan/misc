# trend line segmentation, reference implementation
# Max Kesin
# Releasing under MIT license

import pylab
import math

pylab.ion()

# sample YAHOO data
price_data = [15.93,16.46,15.82,16.07,16.08,16.39,16.65,16.78,17.25,16.81,16.88,16.65,16.77,16.68,16.81,17.17,17.22,16.94,16.92,16.83,\
16.84,16.74,16.69,16.35,15.88,16.11,15.94,15.72,15.57,15.77,15.9,15.85,15.34,15.52,15.45,15.36,15.32,15.33,15.17,15.03,14.9,15.04,\
15.29,15.38,15.58,15.6,15.83,16.02,15.89,16.08,16.04,16.1,16,16.08,16.13,15.89,15.8,15.9,15.71,15.75,16.06,16.19,16.69,16.69,17.05,\
17.71,17.54,17.98,17.37,16.8,16.61,16.84,16.93,16.95,16.96,17.43,17.63,17.22,16.96,16.85,17.23,17.65,17.48,17.5,16.98,16.8,17.31,17.1,\
17.17,17.23,17.7,17,16.57,16.01,15.45,15.53,15.28,14.45,14.65,14.26,14.36,14.08,14.5,14.74,14.98,14.92,15.09,15.12,14.89,14.88,14.75,14.58,14.64,14.69,14.98,14.74,14.47,14.54,14.66,14.86,14.76,14.76,14.44,14.56,14.72,15.13,16,16.97,17.37,17.43,17.41,16.19,17.05,17.18,16.75,15.8,15.23,15.07,14.95,14.78,14.48,14.44,14.92,14.83,15.24,15.49,15.85,15.86,15.6,15.44,14.76,14.75,15.55,15.5,15.62,15.91,16.33,16.56,16.17,16.26,16.7,16.23,16.47,16.77,16.4,16.5,16.6,16.17,15.19,15.09,15.27,14.68,14.89,14.92,15.08,15.06,15.1,15,14.5,14.92,15.5,14.9,14.88,15.03,14.8,14.55,14.2,14.5,14.12,13.7,13.74,14.48,14.79,14.56,14.62,13.94,14.16,14.43,14.15,13.93,14.4,14.02,13.14,12.9,13,13.08,12.95,13.04,12.7,12.76,12.93,13.17,13.55,13.69,13.98,13.79,13.63,13.68,13.81,13.35,13.66,13.58,13.35,13.31,12.81,12.85,12.6,12.77,12.72,12.79,12.85,12.66,12.88,12.45,12.57,12.2,11.9,12.35,12.12,12.31,12.67,12.5,12.87,13.54,13.59,13.41,12.93,12.67,12.3,11.5,11.86,12.02,12.23,11.2,11.26,10.9,11.35,11.17,11.72,11.87,12.32,12.26,12.09,13.09,13.42,12.37,12.71,12.96,12.72,12.17,11.95,11.91,12.46,12.3,12.41,12.47,13.03,12.92,13.13,13,12.88,13.1,12.31,13.16,12.67,11.9,12.17,10.96,11.38,11.12,10.81,11.82,10.76,9.93,10.12,9.56,9.28,9.1,11.54,11.93,10.5,10.84,10.32,11.01,11.56,12.37,12.45,14.84,13.21,13.05,12.74,13.09,12.53,12.2,11.89,11.82,11.31,12.15,12.36,12.62,13.03,12.88,11.9,12.49,13.78,13.14,12.22,13.9,13.8,15.19,15.27,15.81,16.77,17.17,17.15,18.77,18.75,19.09,18.9,18.71,19.6,20.58,18.79,18.97,18.25,18.27,18.43,17.4,17.63,18.14,18.33,17.92,18.71,18.85,19.63,19.54,19.48,19.08,19.12,19.34,19.11,19.06,19.57,19.78,20.47,20.27,20.2,20.33,20.21,19.89,20.19,19.8,19.77,19.7,19.77,20.09,19.89,20.18,20.01,20.99,20.55,20.61,21.91,21.39,21.66,22.55,23.49,21.7,21.79,23.12,23,23.76,24.74,23.83,23.4,21.35,21.89,20.48,21.12,21.29,21.59,22,21.17,22.07,22.49,22.78,23.22,23.58,22.95,22.82,26.33,26.42,26.32,26.5,26.5,26.46,26.25,26.36,26.8,27.07,27.34,27.42,27.5,27.48,27.3,27.34,27.68,27.9,27.73,27.54,26.95,25.15,25.8,26.01,25.66,25.57,25.54,23.05,27.65,27.69,27.17,26.35,27,26.85,28.01,28.24,28.73,28.52,28.44,28.4,28.11,28.05,28.18,28.41,28.39,27.8,27.72,27.8,28,27.65,28.57,28.07,28.56,28.32,28.49,28.63,28.14,27.56,27.36,27.56,26.94,26.5,27.85,28.07,28.89,28.91,28.87,28.58,28.64,28,27.8,27.73,27.94,27.98,28.33,27.93,28.42,28.36,28.76,28.71,29.34,29.95,29.98,29.78,29.81,29.89,28.98,28.63,29.11,28.78,28.33,28.68,18.87,18.62,20.87,21.56,22.24,20.44,19.25,19.29,21.27,22,22.2,23,23.51,23.81,23.19,22.47,23.28,23.12,23.81,23.86,23.8,23.22,23.66,23.6,23.85,24.01,23.88,23.5,22.92,23.22,23.8,24.13,24.39,24.82,25.15,25.51,25.86,25.88,26.63,26.14,26.64,26.96,26.01,26.03,25.18,26.08,25.98,26.11,26.93,27.11,25.66,24.94,26.42,25.53,25.8,26.13,28.11,29.27,31.76,30.71,30.54,30.86,31.5,31.55,34.07,32.43,30.75,30.68,30.12,28.93,29.36,28.59,29.1,27.37,28.32,27.76,28.44,28.43,28.35,28.01,27.78,27.19,27.16,27.2,26.76,26.49,26.95,26.7,25.7,26.13,25.54,25.28,25.09,25.06,24.5,23.69,23.6,23.64,23.31,23.85,23.76,24.22,24.1,23.3,22.81,22.49,22.6,22.95,23.59,23.03,23.35,23.22,23.25,23.64,23.26,23,23.56,24.69,24.21,23.93,23.67,23.46,22.75,23.03,23.2,22.65,23.17,23.88,23.55,23.98,24.4,25.01,24.8,25.43,25.7,26.32,26.07,26.74,26.48,26.87,26.7,27.03,27.09,26.92,27.01,26.92,26.95,27.19,27.21,27.44,27.51,27.73,27.6,27.68,27.69,27.89,29.4,27.72,27.49,27.38,27.12,27.3,27.27,27.02,27.34,28.05,28.4,28.6,28.9,28.76,28.19,28.36,28.44,28.65,29.1,29.33,29.62,28.9,28.99,28.89,29.16,29.79,29.62,30.52,30.17,30.24,30.13,33.27,28.25,27.72,28.25,28.32,28.35,27.98,28.22,28.03,27.53,27.86,28.1,28.42,31.98,31.68,31.15,31.26,31.65,31.64,32.01,32,31.61,31.41,31.22,31.21,31.71,31.45,31.56,31.25,31.33,31.36,30.33,30,30,30.02,29.81,29.63,29.77,29.3,29.85,30.82,30.95,30.89,30.18,30.54,30.13,30.86,31.38,32.8,31.6,31.6,31.74,31.8,31,30.82,29.69,29.37,29.29,30.07,29.75,29.35,28.61,28.67,28.57,28.68,28.04,27.87,28.05,28.33,28.68,28.34,27.42,27.85,27.93,28.92,29.4,29.88,28.98,28.76,27.48,28,27.7,26.7,25.64,25.85,25.42,25.62,25.47,25.49,25.67,25.71,26.24,26.05,26.89,27,26.63,27.05,26.63,26.37,26.65,26.95,27.25,26.87,26.49,27,27,27.4,27.03,27.5,28.22,27.51,26.5,26.96,26.68,27.31,27.18,27.4,27.17,27.4,27.18,26.36,26.69,26.34,26.63,25.94,26.5,26.44,25.87,25.23,24.7,23.73,23.35,23.14,23.22,23.02,24.57,23.74,24.34,23.9,24.32,24.29,24.94,25.45,25.09,25.16,24.89,24.81,25.45,25.5,24.87,25,25.44,25.64,25.34,25.53,26.04,29.09,29.37,29.3,29.1,29.06,28.55,28.05,28.04,28.4,28.94,29.45,28.91,28.99,29,28.86,28.75,28.95,28.75,29.34,28.84,29.22,28.9,28.38,28.35,27.58,27.71,27.52,26.95,27.75,26.95,26.92,27.2,26.5,27.01,27.06,27.46,26.9,27.35,26.78,26.75,26.24,24.99,25.55,26.41,32.08,31.98,32.34,32.85,33.03,32.79,32.91,32.94,32.77,32.85,32.9,33.01,32.26,31.75,31.85,31.45,31.08,30.85,30.77,30.42,30.51,30.7,29.98,29.81,29.77,30.37,30.7,30.43,30.8,30.83,31.19,32.11,31.83,32.19,32.73,32.86,32.94,30.95,31.04,30.42,29.05,30.1,30.61,31.1,30.85,30.71,31.96,32.48,32.68,33.09,32.63,32.4,32.4,32.2,32.99,32.88,32.79,32.3,32.99,33.01,33.36,33.48,33.47,31.17,31.16,31.14,31.44,32.45,32.28,32.85,32.12,32.3,31.69,32.41,32.45,32.75,32.44,31.45,31.84,32.28,31.52,30.33,30.11,30.38,30.35,30.77,31.25,30.1,30.72,30.4,31.05,31.31,31.42,31.53,31.7,32.01,32.21,32.63,33.11,33.2,33.01,32.49,32.9,32.88,33.3,32.62,32.14,32.21,32.58,33.01,33.24,33.01,33.9,34,35.01,34.45,35.2,35.09,35.26,34.94,35.43,34.55,34.22,34.44,35.82,35.01,39.09,41,41.92,42.19,42.96,43.1,42.88,40.93,41.22,39.69,39.4,40.25,40.1,40.65,41.09,40.69,40.52,41.26,42.16,41.86,41.23,41.12,40.01,40.41,40.5,40.25,40.31,40.78,40.88,41.22,40.74,39.38,41.01,41.63,42.71,42.21,41.73,41.26,42.04,40.32,37.9,38.26,38.43,38.69,37.52,37.76,37.75,37.69,37.59,38.26,37.49,36.62,35.6,35.62,35.34,35.06,35.19,35.3,35.99,35.9,34.62,34.4,33.85,33.62,33.8,33.99,34.55,34.2,34.03,33.95,33.79,33.75,33.8,33.59,32.4,32.67,32.17,32.48,32.12,32.09,32.53,32.88,33.27,33.74,33.95,34.3,33.93,33.42,33.35,33.74,33.5,33.18,33.2,33.28,33.23,33.5,33.4,33.51,33.54,32.92,33.29,34.07,34.39,34.13,34.3,34.57,34.8,34.86,34.54,34.28,34.15,33.86,34.09,34.26,33.75,33.46,33.63,34.01,34.23,34.22,34.05,33.88,33.35,33.75,34.21,37.02,36.45,37.05,37.4,36.42,36.2,34.9,34.77,33.87,34.64,34.25,34.76,34.84,35.8,35.95,35.88,36.26,36.85,36.91,36.37,35.96,36.76,36.46,36.97,36.56,36.66,37.48,36.81,37.42,38.72,37.79,38.24,38.2,37.31,37.03,36.98,36.45,36.25,36.87,36.1,36.6,36.13,35.79,35.2,34.78,34.71,34.95,34.09,34.3,34.48,35,35.1,34.43,34.05,34.44,34.6,34.7,34.7,35.12,34.58,35.21,35.12,34.96,32.96,32.43,32.96,33.63,34.16,34.35,34.97,35.04,34.45,35.14,35.15,34.34,34.18,33.55,32.31,32.18,32.21,31.94,30.91,31.7,31.29,31.53,31.8,31.87,31.61,31.74,31.86,32.43,33.01,33.55,32.4,32.36,32.25,32.07,32.37,31.74,31.53,30.43,32.82,33.25,33.84,34.42,33.81,34.34,34.01,33.45,33.72,34.6,34.64,35.07,34.71,35.27,36.02,35.13,35.04,34.9,35.38,34.71,34.55,35.48,36.07,35.39,38.08,37.1,35.86,36.12,35.88,36.31,36,35.99,36.32,36.69,38.45,38.36,38.04,38.03,37.83,37.85,37.45,37.43,36.47,36.98,36.89,36.77,38.33,38.13,37.98,38.26,38.02,36.83,37.35,38.75,38.71,39.14,37.96,37.9,37.92,38.09,37.83,37.15,36.7,35.99,37.24,37.43,36.95,37.29,37.77,37.87,36.9,36.85,37.24,36.79,37.68,37.57,39.2,37.03,35.91,36.08,35.82,34.9,35.12,34.83,36.57,35.4,34.38,35.44,34.32,34.89,34.98,35.95,33.71,34.4,34.48,34.88,34.72,34.52,35.05,34.35,33.59,32.78,32.27,32.54,33.19,32.71,32.81,33.35,32.85,33,32.89,32.7,31.62,31.01,30.24,30.2,29.61,29.87,29.75,28.7,28.39,28.48,29.07,29.43,29,28.36,28.99,29.1,27.88,28.34,27.46,28.63,27.39,27.83,27.43,26.4,26.16,26.29,26.47,28.46,27.98,30.41,30.57,30.25,30.56,29.79,28.6,28.45,28.2,27.82,30.11,28.2,28.9,30.72,31,29.74,30.59,29.66,30.88,29.42,33.07,34,34.46,35.14,35.99,35.38,35.08,34.37,33.64,32.54,31.96,32.2,32.11,32.39,32.41,31.99,32.18,32.73,32.95,32.32,32.36,31.88,31.66,32.45,30.49,30.41,30.41,29.78,28.94,28.84,28.3,28.12,28.61,27.49,26.35,27.54,27.18,26.81,52.35,52.39,52.42,53.2,52.97,52.34,50.53,54.41,55.78,57.77,56.98,56.45,57.35,54.78,53.9,55.87,53.87,53.93,54.81,53.67,54.99,55.78,55.72,48.45,49.11,50.06,50.52,48.82,48.74,47.6,47.2,46.75,44.98,44.27,44.75,45,44.86,44.79,44.16,42.09,43.15,41.88,41.29,43.33,43.87,44.33,43.59,43.46,42.83,44.12,44.55,43.45,43.18,44.39,44.86,46.44,45.94,46.42,46.6,46.78,47.61,47.57,47.03,46.76,46.28,46.22,45.28,44.82,46.67,47.1,46.76,46.54,47.04,48.07,46.82,47.24,47.77,47.24,47.9,48.46,46.56,49.38,49.73,48.25,48.04,48,46.9,46.44,45.76,45.5,45.05,44.93,44.45,44.8,43.46,42.35,41.83,41.93,41.06,40.58,41.94,43.84,43,41.07,41.56,43.04,42.78,42.79,42.95,43.67,43.86,43.42,42.85,42.77,41.86,40.2,39.29,38.91,38.48,40.75,40.92,42.88,42.36,40.57,41.25,42.3,43.19,43,43,43.9,43.74,43.46,43.8,42.94,41.49,40.8,39.96,41.01,42.15,42.1,42.5,42.53,41.63,42.81,42.3,42.9,42.6,41.4,39.06,39.38,39.35,38.96,36.51,36.1,36.03,35.42,36.58,36.12,37.84,36.7,36.69,37.15,35.8,35.71,34.75,34.9,34.39,34.75,34.49,35.26,34.65,34.35,33.61,34,33.34,32.4,32.4,31.89,31.84,31.89,33.02,32.3,31.49,31.55,29.97,29.89,29.75,29.93,29.15,28.9,29.12,29.3,29.64,30.66,31.09,31.63,31.19,31.71,32.57,32.92,32.55,32.65,31.86,31.28,30.7,30.99,31.65,32.75,32.32,32.9,32.84,32.47,35.07,35.24,35.5,33.6,33.72,32.86,32.66,33.1,31.7,31.2,31.44,31.9,32.3,32.11,30.99,30.95,29.85,29.63,29.73,28.32,27.6,28.55,30.01,29.5,28.45,28.93,30.31,30.3,29.95,30.01,27.88,27,26.3,26.58,26.34,27.47,27.42,27.08,27.21,25.96,24.98,25.13,24.65,25.01,25.08,25.34,24.75,24.79,24.92,25.22,25.2,25.8,25.19,25.76,25.12,25,24.71,25.01,24.12,23.79,24.35,23.72,23.81,24.18,25.02,24.05,24.05,23.04,23.3,23.82,24.28,24.7,24.49,23.36,22.83,23.58,22.03,22.05,21.85,20.12,20.5,19.69,18.94,19.26,19.39,19.25,19.83,19.98,19.92,20.79,20.03,19.81,19.58,19.45,19.52,19.5,19.41,19.1,18.85,18.31,18.69,18.2,18,17.57,17.77,17.72,17.83,17.83,18.05,17.82,18.67,18.41,18.35,18.18,19.06,18.85,17.89,18.21,18.6,18.3,19.97,19.56,20.33,18.8,18.92,18.87,17.87,17.85,17.5,16.59,16.35,16.45,16.86,17.32,17.33,16.8,17.01,16.57,17.22,17.1,17.38,17.4,16.8,16.3,15.87,16.6,16.32,17.06,17.16,17.36,18.7,18.49,18.33,18.42,18.5,18.7,17.99,17.17,17.26,17.4,16.38,15.96,15.39,15.09,15.53,15.48,16.15,17.09,16.3,15.51,14.7,15.02,14.29,14.51,15.35,14.85,15.4,14.56,14.51,14.61,14.41,14.74,13.8,14.98,12.89,12.25,11.36,9.44,9.38,9.25,9.54,9.56,9.67,9.9,10.38,10.2,10.23,9.25,8.95,9.58,9.7,9.56,10,10.65,10.46,10.2,10.48,10.43,10.15,9.63,9.56,9.63,9.78,10.04,10.17,9.74,10.64,11.53,12.16,12.75,13.02,13.35,13.17,12.05,12.12,11.9,11.13,11.89,11.68,11.75,11.39,12.01,11.24,11.59,12.17,13.06,13.16,12.92,12.95,12.47,13.06,12.3,13.54,13.16,13.34,14.07,14.24,12.86,12.81,12.79,11.15,12.92,12.98,13.3,13.18,11.95,13.58,14.76,14.1,14.43,13.03,15.2,15.39,15.06,16.03,16.46,16.52,15.91,15.5,15.63,15.63,15.97,15.87,15.5,15.97,16.06,15.51,16.12,16.63,16.36,16.49,17.15,16.87,16.53,16.59,17.22,17.71,18.19,17.66,17.17,16.69,15.66,16.2,15.65,15.23,14.78,14.64,15.02,15.19,14.79,14.22,14.47,14.91,14.24,14.68,14.11,14.73,15.2,15.77,15.58,15.53,15.9,15.82,16.86,18.7,18.95,17.6,17.74,17.81,18.23,18.44,18.75,18.03,17.71,17.62,18.4,18.42,18.35,18.67,19.17,18.74,19.5,19.04,18.75,19.35,18.51,18.44,18.31,17.85,17.29,17.13,14.93,14.63,15.09,15.11,14.42,14.3,15.15,14.74,15.12,16.7,16.92,16.68,16.38,16.4,15.41,15.66,16.09,15.56,16.55,17.26,17.7,18.19,18.81,18.83,18.32,18.93,18.8,19.9,19.66,19.37,18.92,19.22,19.71,20.52,20.06,19.8,19.4,18.7,19,18.7,18.14,18.51,18.65,17.95,18.05,16.89,16.97,17.6,17.95,18.34,17.2,18.04,18.21,19.03,18.5,17.63,17.91,17.54,17.13,16.29,16.3,16.7,16.6,17.04,17.4,16.35,15.18,14.98,15.88,16.04,15.27,14.89,14.57,14.26,13.55,13.22,13.78,12.8,11.9,11.26,11.13,11.07,11.53,11.04,11.95,12.14,11.47,11.78,11.93,11.4,11.12,11.49,13.03,12.19,11.86,12.21,11.96,10.08,10.41,10.05,10.3,10.17,8.91,9.02,8.7,9.16,8.04,9.35,9.16,9.09,9.33,9.95,10.19,10.8,10.55,10.73,10.74,11.03,11.69,11.96,11.32,12,13.14,13.52,14.07,13.38,13.29,13.44,14.68,14.04,14.5,13.96,15.05,15.89,15.52,16.09,16.56,17.23,17.35,17.75,18.49,18.69,18.06,17.95,18.18,17.42,16.88,16.99,17.08,18.23,17.28,17.57,17.95,17.84,18.03,18.17,18.57,16.94,18.92,18.15,18.94,20,19.76,19.66,19.46,19.21,19.5,19.05,18.09,18.04,18.18,15.31,16.38,16.51,16.15,17.06,18.33,17.5,18.24,19.39,19.3,19.89,19.7,20.46,18.59,17.93,18.37,20.85,21.32,20.4,21.87,22.15,19.4,19.56,19.49,17.82,17.3,17.8,18.24,19.32,19.24,20.36,20.02,19.87,21.81,22.77,20.11,20.26,19.11,18.95,17.85,18.25,19.11,20.2,18.99,18.41,17.32,16.52,15.88,17,16.04,15.82,15.25,15.06,11.88,13.56,15.38,15,14.88,15.38,14.5,15.13,15.38,14.06,13.94,15.25,14.06,14.63,15.88,15.38,16.75,16.25,17.19,17.06,21.97,23.5,22.5,22.92,23.56,23.69,25.25,25.87,24.19,26.5,26.19,28.94,29.31,29,27.44,28.94,28.31,30.19,33.69,35.13,35.19,32.69,36.5,37.5,39.81,41.13,37.75,37.63,41.88,38.31,34.44,33.31,36,31,28.62,27,26.06,24.42,29.31,26.56,27.37,29.37,29.86,27.75,30.31,30.31,29.44,31,32,26.44,26.75,25.81,30.56,33.88,32,35.31,38.31,33.25,33.63,37.13,36.06,41.63,39.69,38.44,38.81,37.59,37.14,39.94,43.73,40.25,40.38,47,50.38,52.2,55,58.25,57.69,54.81,57.81,60.86,69.25,65.94,70.25,69.37,66.5,57.78,53.69,53.81,57.13,56.75,60.88,61.44,60.25,59.38,57.38,46.44,55.94,60.75,55.19,66.69,72.69,87.37,81.56,85.5,88.5,84.44,87.5,91.56,97.12,91.37,102.75,106,110.34,103.87,108.86,109.25,105.5,104.19,107,107.81,105.56,108.81,103.25,107.19,110.56,117.37,111.87,117.87,123.62,121.69,120.73,128.5,138.81,133.38,125.75,129,124.69,130.38,133.31,134.5,131.19,129.25,128.25,132.56,136.38,135.19,133.47,132.75,124.87,126.69,128.5,126.19,134.69,134.19,136.31,134.06,136.88,138.13,134,130.06,129.38,126.75,124.62,125.56,120.5,104.94,113.81,117.06,121.37,126,122.5,118.81,122.56,125.31,118.87,124.5,129.25,141.88,142.31,140.38,140,139.88,138.25,140.06,136.69,145,146.56,146.88,138.5,135.75,130.88,129.86,116.19,113.75,115.69,114.5,121.5,117.5,125.25,120.12,131.38,137.5,132.5,133.38,125.12,126.5,121.81,115.31,121.5,122.94,122,124.5,120.31,129.13,134.75,126.75,114.5,124.5,118.75,115,126.5,129.38,116.94,111.25,130.25,136.97,136.63,139.56,152.88,156.75,161.94,162,165,168.75,175.25,172.5,193.44,197,195.63,193.5,193.38,189.44,173,172.19,169.13,159.19,168.75,178.5,168.13,181.17,175.25,174.63,174.88,163.5,156,155.02,157.5,164.44,161.48,165.63,166.48,153.63,156.88,161.25,165.88,168.25,166.38,173.5,363.88,362.5,370,359,354.05,364.5,334.86,321.48,319.44,310,333.56,332.44,340.5,327,353.94,355,369.06,336,341.75,355,366.5,389.88,423.88,432.5,366.75,406.25,430.5,464.5,442.92,420.44,421.75,396.44,410,393.75,417.5,405.75,367.63,348,344.75,332.5,327.38,348.25,348.02,346.75,319.88,324,296,253,249.98,230.38,230,223.44,229.25,233,226.25,226,219.5,213.94,206.63,211.06,205.69,196,196,198.5,193.38,199.25,182.63,186.13,183.06,179.44,181,179.5,178.5,174.06,177.5,179.25,176.59,182.25,176.88,176.75,174.5,169.69,167,169.94,173.19,181.88,187,188,184.69,176,172.22,177.19,178.5,179.63,182,181.25,186,173.31,180.31,169.5,165.81,164.5,162.81,162.13,168.25,159.75,166.75,165.63,157.81,152.81,153.56,147.63,140.25,148.75,142.44,148.5,153.38,157.5,154.75,149.94,147,139.63,141.5,143.25,136.38,132,132.38,128,130.25,120.75,128.13,131.13,120.12,125,134.44,135.06,137.75,139.13,133.44,138.13,141.5,146.56,148.31,142.88,148.13,150.88,153.75,160.5,159.75,147.88,159.5,165.44,173.81,172.25,182.5,177,174.38,159.88,155.81,147.56,152.75,155,149.75,157.38,148.5,141.38,139.63,133.25,117.62,134.69,144.38,143.69,144.88,152.38,146.63,136.13,142.5,136.25,145.31,134.5,139,130,138.44,149.38,153.25,158.38,158.94,159.38,155.06,154.44,171.5,170.88,164.38,148.25,151.63,162,160.38,162.25,171.13,180.06,168.13,182.75,194.94,189.13,183.38,182.69,174.63,161.25,188.88,195.5,189.75,204.25,204.75,193.13,204.69,217,229,220,186.25,179,176,175.38,177,174.38,167.94,152.38,162,170.88,176.75,170.06,174.13,180.31,177,178.75,177.88,173,170.81,162.36,158.38,156.75,154.88,161.38,153.56,155.5,149.56,156.5,148.5,137,133.56,134,134.5,152.5,154.56,149,139.5,157.38,172.75,344.13,356.5,323.13,335.75,357,360,348.88,372.38,319.5,296.75,253,274.06,326.44,339.88,344.94,371.88,399.13,438.63,367.94,346,284,268,242.56,242,241.88,266,275.38,253.5,246.13,251.25,252.5,221,211.63,200.13,204.13,194.5,192.38,191.13,198.44,200,189.5,192.5,191.31,197.75,204.81,183.88,217.63,212.81,210.75,216,196.88,193,193.94,179.38,171.69,173.75,176.88,163.5,177.5,168.5,154,151.94,149.81,147.63,144.75,133.06,129.88,128.25,123.62,130.5,123.25,121.69,118.94,117.62,120.25,114.62,120.12,112.87,108.5,113.44,110.5,107.87,104.12,122.69,131.13,126.12,115.56,123.37,128.97,128.75,126,112,118.75,104.75,98.25,87.25,90,89.37,85.81,82.62,82.25,80.5,76.75,83.62,82.87,76.94,74,77,66.12,83,90.87,94.5,95.75,98.94,96,96.12,95.37,98.87,92.87,90.87,94,95.12,93.5,89.69,92,88.62,82,85.87,88.62,90,183.75,177.38,185.75,188.5,178.75,191.5,194.13,190,196.63,186.5,185.75,182.38,187.38,188.75,177.63,181.38,199.75,185,206.75,178.88,173.5,160.13,154.75,149.5,150.75,148.5,148.94,139.25,129,127.12,132.75,124.62,116.37,111.87,116,115.12,117,111.06,105,102.5,102,105.75,105,108.25,110.5,114.12,106.5,115.12,116.37,118.5,119.37,117.75,118.87,122,123.06,116,113.5,118.62,114.75,115,117.12,118.37,120.06,119.37,120.25,118,117.19,111.62,113.87,115.62,124.25,126.75,122.25,123.62,119,116.75,112.75,112.5,107.75,94,98.5,103.75,105.06,99,92.44,94,91.62,90.19,88.12,88.12,82.75,82.5,84.37,85.75,82.5,85.12,85.5,82.25,83.87,85.37,90.5,81.75,76.75,69.5,71.75,72,74.75,68.25,62,61.88,63.88,64.37,64.5,63.5,64.25,64.5,64.75,64.25,64.62,64,64.75,62.13,64.37,64.62,65.75,64.25,63,58,60.63,60.25,62.38,62.75,63.38,64.12,65.25,66,65.25,66.75,64.75,60,64.5,64,62.75,61.75,64.37,69.25,70.62,68.87,67,64.31,65.19,64,61.88,57.5,59.5,60.5,57.88,60,58.75,57,58.5,58.88,56.5,53.56,54.38,52.5,53.75,51.5,51.13,51.75,50.25,52.5,54.13,51.25,50.88,51.63,49.88,46,45.13,44.75,49.13,49.63,49,53,50.88,45.63,45,43.13,39.38,44.5,34.13,47,51.75,50.75,52.38,49.75,48.75,48.25,51.75,50.75,51.63,53.13,54,55.5,57.25,57.75,55.25,55,51.13,50.25,50.63,50.5,50.5,51.75,51.13,54.13,52.13,49.5,49.13,51.5,48.25,53,56.63,53,51.69,48.13,46.75,42.25,41.25,40.38,40.25,56.5,55.38,55.88,56.5,56,53.5,57.5,55.5,52.63,48.63,49.5,50.38,51,53.5,54,53.5,55.5,54.63,53.75,54.75,56,55,49.75,47.63,48.25,47.75,49,50.75,49.75,47.5,46.38,49.13,51.25,48.25,44,43,45.38,40.75,37.75,34,34.38,34.13,35,34.38,36.13,36.63,37.56,37.25,38.13,35,34.5,34.75,34.75,32.5,32,31.25,32.38,32.5,32,32,32.13,32.75,33.13,32.75,31.5,31.87,31.62,31.37,31.25,33.25,32.38,32.13,31.75,30.62,30.25,30.5,32.75,34,34.38,33.88,32.63,35.38,35.5,33.75,34.5,31.87,31.62,30.25,30.62,31.25,27.75,28.09,30.5,33.13,31.5,31,33,33.88,31.5,34.88,34.63,33.63,32.75,29.12,30,29.37,27.87,28.87,30,28.12,29.37,28.75,29.37,27.12,22.75,23.25,25.5,23.12,25.62,26,26.75,27.25,26.25,26.75,28.62,30.12,29.87,30.62,31.25,32,31.25,31.25,32,32.75,34,34.25,35.5,35.5,32.13,29.25,30.12,31.75,33.5,34.38,34.63,33.88,34.5,33,32.63,36.63,33.13,34.63,32.13,31.62,28.87,26.5,26,25.37,23,21.87,19.87,19,18.87,20.19,19.87,19.12,17.62,17,17.5,18.25,18.25,18,18.12,17.5,18.12,18.5,18,18.62,20,19.5,19.5,19.87,21.25,20.37,20.25,19.75,19.87,18.75,18.75,18.5,19,19.25,17.62,17.5,17.62,17.87,18.12,18.25,18.37,19,19.75,19.87,19.5,18.12,17.87,18,19,19.5,19.5,20,20.5,20.62,20.5,20.87,21,21.25,21.87,21.75,22.25,21.12,21.37,21.5,20.87,20.37,22.75,20.87,22.37,22,23.12,22.12,20.37,21,21.75,21.87,21.62,22.5,23.75,23.87,21.5,20.75,21.5,21.12,20.62,19.87,18.75,18.75,18.75,18.12,18.25,18.37,19,19,19.87,20.87,20.12,19.75,20.12,19.75,18.62,19.12,19.62,19.37,19.5,20.37,20.12,17,17.5,17.37,18,17.87,19.25,19,18.5,18,17,16.25,16.25,16.25,15.75,16.25,17.5,19,19.87,19.5,18.12,17.75,18,17,16,18.75,19.5,20,20,21.75,22.25,20.5,19.5,21.25,21.5,21.75,22.25,22.25,21,21,21.75,24.75,24.75,25.75,25.75,26.12,26.87,27.25,28.5,27.5,27.25,27.75,28.75,27.5,28.75,29.25,29.5,27.5,28,29,30,30.25,29.75,30,30.75,31.37,30.75,30,30.5,30,32.5,32.25,31.5,30.25,31.25,31.5,32,30,28.5,28.75,29,30.12,30.12,28.25,32.25,35.75,25.25]

def get_y(x1, y1, x2, y2, x):
    return y1+(y2-y1)*(x-x1)/(x2-x1)

def regression_cost_vert(i1, i2, all_points):
    """
    calculates the cost of dropping the points between indexes i1 and i2 and replacing them with straight line
    uses sum-squared-errors
    """
    x1, y1 = all_points[i1]
    x2, y2 = all_points[i2]
    sum_sq_errors = 0.0
    for i in range(1, i2-i1):
        x, y = all_points[i1+i] # point to drop
        vertical_dist = y - get_y(x1, y1, x2, y2, x)
        error = vertical_dist # we can ignore the sign, as it gets sqared away anyway
        sum_sq_errors += error*error
    return sum_sq_errors

def regression_cost_perp(i1, i2, all_points):
    """
    calculates the cost of dropping the points between indexes i1 and i2 and replacing them with straight line
    uses sum-squared-errors
    """
    x1, y1 = all_points[i1]
    x2, y2 = all_points[i2]
    sum_sq_errors = 0.0
    for i in range(1, i2-i1):
        x, y = all_points[i1+i] # point to drop
        vertical_dist = y - get_y(x1, y1, x2, y2, x)
        perpendicular_dist = vertical_dist*math.cos(math.atan(float(y2-y1)/(x2-x1)))
        error = perpendicular_dist # we can ignore the sign, as it gets sqared away anyway
        sum_sq_errors += error*error
    return sum_sq_errors
    
def segment(points, reg_cost):
    """
    segments the timeseries, returning a reduced set of points
    reg_cost is a function measuring the error, the two most natural implementations
    regression_cost_vert and regression_cost_perp are provided
    """
    if len(points) > 5:
        active_points_list = range(len(points))# stores the *original indecies* of the active points
        while len(active_points_list) > 5:
            min_cost_pos = (1000000, -1)
            for i in range(len(active_points_list)-3):
                cost = reg_cost(active_points_list[i], active_points_list[i+2], points)
                if cost <= min_cost_pos[0]:
                    min_cost_pos = (cost, i+1)
            if min_cost_pos[1] != -1:
                del active_points_list[min_cost_pos[1]]
            
            yield [points[i] for i in active_points_list]

        yield [points[i] for i in active_points_list]
    else:
        yield points

def visualize_segmentation(points):
    line, seg_line = None, None
    raw_input('start')
    pylab.clf()
    x, y = zip(*points)

    for seg in segment(points, regression_cost_perp):# can use other error measures
        xseg, yseg = zip(*seg)
        if not seg_line:
            seg_line, = pylab.plot(xseg, yseg, color = 'r', linewidth=1.3)
        else:
            seg_line.set_xdata(xseg)
            seg_line.set_ydata(yseg)

        if not line:
            line, = pylab.plot(x, y, color='b', linewidth=1.3)            
        else:
            line.set_xdata(x)
            line.set_ydata(y)
        pylab.draw()
        if len(seg) <30:
            raw_input('next')
 
price_data = price_data[:100]           
            
print visualize_segmentation(zip(range(len(price_data)), price_data))


